FROM php:8.2-fpm-alpine3:17

# Install required PHP extensions and dependencies
RUN apk update && apk upgrade && \
    apk add --no-cache \
        curl \
        less \
        mariadb-client \
        zip \
        unzip \
        libpng \
        shadow \
        libpng-dev \
        libjpeg-turbo \
        libjpeg-turbo-dev \
        libzip-dev && \
    docker-php-ext-configure gd --with-jpeg && \
    docker-php-ext-install -j$(nproc) \
        pdo_mysql \
        mysqli \
        gd \
        zip && \
    # Make sure the zip extension is properly installed
    docker-php-ext-enable zip && \
    apk del libpng-dev libjpeg-turbo-dev libzip-dev && \
    rm -rf /var/cache/apk/*

# Install wp-cli
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && \
    chmod +x wp-cli.phar && \
    mv wp-cli.phar /usr/local/bin/wp

# Set working directory
WORKDIR /var/www/html/wordpress

# Download and extract WordPress
RUN wp core download --allow-root

# Copy PHP-FPM configuration
COPY ./conf/www.conf /usr/local/etc/php-fpm.d/www.conf
# Copy wp-config setup script
COPY ./tools/wp-setup.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/wp-setup.sh

# Switch to non-root user
RUN if getent passwd www-data > /dev/null 2>&1; then \
        usermod -u 82 www-data; \
    else \
        adduser -u 82 www-data; \
    fi && \
    chown -R www-data:www-data /var/www/

USER www-data

CMD ["/usr/local/bin/wp-setup.sh"]